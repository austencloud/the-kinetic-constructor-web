<script lang="ts">
	import MenuBar from '$lib/components/MenuBar/MenuBar.svelte';
	import TabContent from './TabContent.svelte';
	import { createEventDispatcher } from 'svelte';
	import SequenceInspector from '$lib/components/Developer/SequenceInspector.svelte';
	import { selectIsSettingsOpen } from '../MainWidget/state/store';
	import { actions } from '../MainWidget/state/actions';
	import SettingsContent from './SettingsContent.svelte';

	// --- XState Imports ---

	// --- Props & Events ---
	export let background: string;

	// --- Events Emitted Up ---
	const dispatch = createEventDispatcher<{
		changeBackground: string;
		tabChange: number;
	}>();

	// --- Get State from XState ---
	const isSettingsDialogOpen = selectIsSettingsOpen();

	// --- Event Handlers ---
	function handleToggleSettings() {
		// Toggle settings dialog
		if ($isSettingsDialogOpen) {
			actions.closeSettings();
		} else {
			actions.openSettings();
		}
	}

	// This function will be passed down as a prop.
	function handleBackgroundChange(newBackground: string) {
		const validBackgrounds = ['snowfall', 'nightSky']; // Keep updated
		const backgroundType = newBackground.toLowerCase();
		if (validBackgrounds.includes(backgroundType)) {
			dispatch('changeBackground', backgroundType);
		} else {
			console.warn(`Invalid background type requested: ${newBackground}. Using default.`);
			dispatch('changeBackground', 'snowfall');
		}
	}

	// Handler for tab changes bubbling up
	function handleTabChange(event: CustomEvent<number>) {
		dispatch('tabChange', event.detail);
	}

	// For compatibility with the updated SettingsContent component
	const currentSection = 'Construct';
</script>

<div class="content">
	<!-- Use the MenuBar component directly with proper event handling -->
	<div class="menuBar">
		<MenuBar on:settingsClick={handleToggleSettings} on:tabChange={handleTabChange} />
		{#if import.meta.env.DEV}
			<SequenceInspector />
		{/if}
	</div>

	<div class="mainContent">
		<TabContent activeTab="defaultTab" {background} onChangeBackground={handleBackgroundChange} />
	</div>

	{#if $isSettingsDialogOpen}
		<div class="settingsContent">
			<SettingsContent onClose={() => actions.closeSettings()} {currentSection} />
		</div>
	{/if}
</div>

<style>
	.content {
		display: flex;
		flex-direction: column;
		flex: 1;
		min-height: 0;
		z-index: 1;
		width: 100%;
	}
	.mainContent {
		display: flex;
		flex: 1;
		overflow: hidden;
		position: relative;
		z-index: 0;
		width: 100%;
		opacity: 1;
	}
	.settingsContent {
		flex: 0 0 auto;
		width: 100%;
		background: rgba(30, 40, 60, 0.8);
		backdrop-filter: blur(10px);
		border-top: 1px solid rgba(108, 156, 233, 0.2);
		max-height: 50vh;
		overflow: auto;
	}
	.menuBar {
		padding: 5px 10px;
	}
</style>
